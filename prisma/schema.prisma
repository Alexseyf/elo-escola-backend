generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model School {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  slug      String   @unique @db.VarChar(50)
  active    Boolean  @default(true) 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  legalName       String?           @db.VarChar(255)
  cnpj            String?           @unique @db.VarChar(14)
  logoUrl         String?
  primaryColor    String?           @db.VarChar(7)
  timezone        String            @default("America/Sao_Paulo") @db.VarChar(50)
  subscriptionPlan SubscriptionPlan @default(BASIC)

  usuarios      Usuario[]
  turmas        Turma[]
  alunos        Aluno[]
  diarios       Diario[]
  cronogramas   Cronograma[]
  eventos       Evento[]
  atividades             Atividade[]
  logs                   Log[]
  periodosSono           PeriodoSono[]
  diarioItensProvidencia DiarioItemProvidencia[]
  professoresTurmas      ProfessorTurma[]
  responsaveisAlunos     ResponsavelAluno[]

  @@map("schools")
}

enum SubscriptionPlan {
  BASIC
  PRO
  PREMIUM
}

model Usuario {
  id                Int                @id @default(autoincrement())
  nome              String             @db.VarChar(60)
  email             String             @db.VarChar(40)
  senha             String             @db.VarChar(60)
  telefone          String             @db.VarChar(20)
  isAtivo           Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  resetToken        String?
  resetTokenExpires DateTime?
  senhaAlterada     Boolean            @default(false)
  roles             UsuarioRole[]
  turmasLecionadas  ProfessorTurma[]
  alunosResponsavel ResponsavelAluno[]
  logs              Log[]
  cronogramas       Cronograma[]
  eventos           Evento[]
  atividades        Atividade[]
  
  // Opcional para PLATFORM_ADMIN
  schoolId          String?
  school            School?          @relation(fields: [schoolId], references: [id])

  @@unique([email, schoolId])
  @@index([schoolId]) // Desempenho para consultas de tenant
  @@index([schoolId, isAtivo]) // Desempenho para usuários ativos por tenant
  @@map("usuarios")
}

model Role {
  id       Int           @id @default(autoincrement())
  tipo     TIPO_USUARIO  @unique
  usuarios UsuarioRole[]

  @@map("roles")
}

model UsuarioRole {
  id        Int     @id @default(autoincrement())
  usuarioId Int
  roleId    Int
  usuario   Usuario @relation(fields: [usuarioId], references: [id])
  role      Role    @relation(fields: [roleId], references: [id])

  @@unique([usuarioId, roleId])
  @@map("usuario_roles")
}

model Turma {
  id          Int              @id @default(autoincrement())
  nome        TURMA
  grupoId     Int
  grupo       GrupoPorCampo    @relation(fields: [grupoId], references: [id])
  alunos      Aluno[]
  professores ProfessorTurma[]
  eventos     Evento[]
  atividades  Atividade[]

  schoolId    String
  school      School           @relation(fields: [schoolId], references: [id])

  @@unique([nome, schoolId])
  @@index([schoolId]) // Desempenho para listar turmas por tenant
  @@map("turmas")
}

model ProfessorTurma {
  id        Int     @id @default(autoincrement())
  usuarioId Int
  turmaId   Int
  usuario   Usuario @relation(fields: [usuarioId], references: [id])
  turma     Turma   @relation(fields: [turmaId], references: [id])
  
  schoolId  String
  school    School  @relation(fields: [schoolId], references: [id])

  @@unique([usuarioId, turmaId])
  @@index([schoolId, turmaId]) // Desempenho para encontrar professores por turma
  @@index([schoolId, usuarioId]) // Desempenho para encontrar turmas por professor
  @@map("professores_turmas")
}

enum TURMA {
  BERCARIO2
  MATERNAL1
  MATERNAL2
  PRE1
  PRE2
  TURNOINVERSO
}

model Aluno {
  id           Int                @id @default(autoincrement())
  nome         String             @db.VarChar(60)
  dataNasc     DateTime
  isAtivo      Boolean            @default(true)
  mensalidade  Float?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  turma        Turma              @relation(fields: [turmaId], references: [id])
  turmaId      Int
  diario       Diario[]
  responsaveis ResponsavelAluno[]
  
  schoolId     String
  school       School           @relation(fields: [schoolId], references: [id])

  @@index([schoolId, turmaId]) // Desempenho para listar alunos por turma
  @@index([schoolId, isAtivo]) // Desempenho para consultas de alunos ativos
  @@map("alunos")
}

enum TIPO_USUARIO {
  PLATFORM_ADMIN
  ADMIN
  PROFESSOR
  RESPONSAVEL
}

model ResponsavelAluno {
  id        Int      @id @default(autoincrement())
  alunoId   Int
  usuarioId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  aluno     Aluno    @relation(fields: [alunoId], references: [id])
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])

  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id])

  @@unique([alunoId, usuarioId])
  @@index([schoolId, alunoId]) // Desempenho para encontrar responsaveis por aluno
  @@index([schoolId, usuarioId]) // Desempenho para verificações de acesso
  @@map("responsaveis_alunos")
}

model Log {
  id          Int      @id @default(autoincrement())
  descricao   String   @db.VarChar(60)
  complemento String   @db.VarChar(255)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  usuarioId   Int
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])

  // Opcional para PLATFORM_ADMIN
  schoolId    String?
  school      School?  @relation(fields: [schoolId], references: [id])

  @@index([schoolId, createdAt]) // Desempenho para listar logs por tenant
  @@map("logs")
}

model Diario {
  id               Int                     @id @default(autoincrement())
  data             DateTime                @db.Date
  observacoes      String                  @db.VarChar(500)
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  alunoId          Int
  disposicao       DISPOSICAO?
  lancheManha      REFEICAO                @default(NAO_SE_APLICA)
  almoco           REFEICAO                @default(NAO_SE_APLICA)
  lancheTarde      REFEICAO                @default(NAO_SE_APLICA)
  leite            REFEICAO                @default(NAO_SE_APLICA)
  evacuacao        EVACUACAO?
  aluno            Aluno                   @relation(fields: [alunoId], references: [id])
  periodosSono     PeriodoSono[]
  itensProvidencia DiarioItemProvidencia[]
  
  schoolId         String
  school           School                  @relation(fields: [schoolId], references: [id])

  @@unique([alunoId, data])
  @@index([schoolId, alunoId]) // Desempenho para listar diarios por aluno
  @@index([schoolId, data]) // Desempenho para relatórios por data
  @@map("diarios")
}

model PeriodoSono {
  id          Int      @id @default(autoincrement())
  horaDormiu  String   @db.VarChar(5) // Formato "HH:MM" 
  horaAcordou String   @db.VarChar(5) // Formato "HH:MM"
  tempoTotal  String   @db.VarChar(5) // Formato "HH:MM"
  diarioId    Int
  diario      Diario   @relation(fields: [diarioId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id])

  @@index([schoolId, diarioId]) // Desempenho para encontrar periodos por diario
  @@map("periodos_sono")
}

model ItemProvidencia {
  id      Int                     @id @default(autoincrement())
  nome    ITEM_PROVIDENCIA        @unique
  diarios DiarioItemProvidencia[]

  @@map("itens_providencia")
}

model DiarioItemProvidencia {
  id                Int             @id @default(autoincrement())
  diarioId          Int
  itemProvidenciaId Int
  diario            Diario          @relation(fields: [diarioId], references: [id])
  itemProvidencia   ItemProvidencia @relation(fields: [itemProvidenciaId], references: [id])
  
  schoolId          String
  school            School          @relation(fields: [schoolId], references: [id])

  @@unique([diarioId, itemProvidenciaId])
  @@index([schoolId, diarioId]) // Desempenho para encontrar itens por diario
  @@map("diario_itens_providencia")
}

enum ITEM_PROVIDENCIA {
  FRALDA
  LENCO_UMEDECIDO
  LEITE
  CREME_DENTAL
  ESCOVA_DE_DENTE
  POMADA
}

enum DISPOSICAO {
  AGITADO
  NORMAL
  CALMO
  SONOLENTO
  CANSADO
}

enum REFEICAO {
  OTIMO
  BOM
  REGULAR
  NAO_ACEITOU
  NAO_SE_APLICA
}

enum EVACUACAO {
  NORMAL
  LIQUIDA
  DURA
  NAO_EVACUOU
}

enum TIPO_EVENTO {
  REUNIAO
  FERIADO
  RECESSO
  EVENTO_ESCOLAR
  ATIVIDADE_PEDAGOGICA
  OUTRO
}

enum SEMESTRE {
  PRIMEIRO_SEMESTRE
  SEGUNDO_SEMESTRE
}

enum CAMPO_EXPERIENCIA {
  EU_OUTRO_NOS
  CORPO_GESTOS_MOVIMENTOS
  TRACOS_SONS_CORES_FORMAS
  ESCUTA_FALA_PENSAMENTO_IMAGINACAO
  ESPACOS_TEMPOS_QUANTIDADES_RELACOES_TRANSFORMACOES
}

model CamposDeExperiencia {
  id               Int               @id @default(autoincrement())
  campoExperiencia CAMPO_EXPERIENCIA @unique
  objetivos        Objetivo[]

  @@map("campo_de_experiencia")
}

model Cronograma {
  id         Int         @id @default(autoincrement())
  titulo     String      @db.VarChar(100)
  descricao  String      @db.VarChar(500)
  data       DateTime    @db.Date
  tipoEvento TIPO_EVENTO
  isAtivo    Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  criador    Usuario     @relation(fields: [criadorId], references: [id])
  criadorId  Int

  schoolId   String
  school     School      @relation(fields: [schoolId], references: [id])

  @@index([schoolId, data]) // Desempenho para listar cronogramas por data
  @@map("cronogramas")
}

model Evento {
  id         Int         @id @default(autoincrement())
  titulo     String      @db.VarChar(100)
  descricao  String      @db.VarChar(500)
  data       DateTime    @db.Date
  horaInicio String      @db.VarChar(5) // Formato "HH:MM"
  horaFim    String      @db.VarChar(5) // Formato "HH:MM"
  tipoEvento TIPO_EVENTO
  isAtivo    Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  turma      Turma       @relation(fields: [turmaId], references: [id])
  turmaId    Int
  criador    Usuario     @relation(fields: [criadorId], references: [id])
  criadorId  Int

  schoolId   String
  school     School      @relation(fields: [schoolId], references: [id])

  @@index([schoolId, turmaId]) // Desempenho para listar eventos por turma
  @@index([schoolId, data]) // Desempenho para filtrar por data
  @@map("eventos")
}

model GrupoPorCampo {
  id        Int        @id @default(autoincrement())
  nome      GRUPO_POR_CAMPO @unique
  turmas    Turma[]
  objetivos Objetivo[]

  @@map("grupo_por_campo")
}

model Objetivo {
  id                 Int                 @id @default(autoincrement())
  codigo             String              @unique @db.VarChar(10)
  descricao          String              @db.VarChar(500)
  grupoId            Int
  grupo              GrupoPorCampo       @relation(fields: [grupoId], references: [id])
  campoExperienciaId Int
  campoExperiencia   CamposDeExperiencia @relation(fields: [campoExperienciaId], references: [id])
  atividades         Atividade[]

  @@map("objetivos")
}

enum GRUPO_POR_CAMPO {
  BEBES
  CRIANCAS_BEM_PEQUENAS
  CRIANCAS_PEQUENAS
  CRIANCAS_MAIORES
}

model Atividade {
  id               Int               @id @default(autoincrement())
  ano              Int
  periodo          SEMESTRE
  quantHora        Int
  descricao        String            @db.VarChar(500)
  data             DateTime          @db.Date
  isAtivo          Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  professorId      Int
  turmaId          Int
  campoExperiencia CAMPO_EXPERIENCIA
  objetivoId       Int
  professor        Usuario           @relation(fields: [professorId], references: [id])
  turma            Turma             @relation(fields: [turmaId], references: [id])
  objetivo         Objetivo          @relation(fields: [objetivoId], references: [id])

  schoolId         String
  school           School            @relation(fields: [schoolId], references: [id])

  @@index([schoolId, turmaId]) // Desempenho para listar atividades por turma
  @@index([schoolId, professorId]) // Desempenho para encontrar por professor
  @@index([schoolId, data]) // Desempenho para relatórios por data
  @@map("atividades")
}
